
const { BitcoinTxStream } = require('../index.js')
const fs = require('fs');

module.exports.testOrdParsing = function testOrdParsing() {

    return new Promise(resolve => {
        const txstream = new BitcoinTxStream(
            { tx: '*' },
            { address: true, ords: true, highWaterMark: 1024 });

        txstream.on('tx', (tx) => {
            console.log(tx, JSON.parse(tx.ords[0].content));
            fs.unlinkSync('./tx1');
            resolve(tx.ords[0].content);
        })

        //this module did not tested on long ord with content length > 0xfd (length order > uint8)

        //tx: d6fd8d9dbe08ec445bc7ab21eba17e3e92188f7017ec3c1afc182e2ea9357388
        //ord dont have OP_PUSHDATA1
        //fs.writeFileSync('./tx1', Buffer.from('0200000000010109c34c2c9d4420b66dfb9987c86f9a804fe16aa89d76142d4fb3a13145877ef80000000000fdffffff02220200000000000022512017e9fe82a3efc9df858890dc5c1c33cae87353843b2c330223eb69b65dd3395d360b0000000000001600148639a85ef445e0fc311c2a8dcf569cc6adb3756c0340f55945bb5c20d367d6a722648309c884dc497886be1b6ce3bcdf501e763733f1552033e4994b7bfb7e1c0f2fefd1d5bda6de237bfca734141c9265ff6ee5fb489720117f692257b2331233b5705ce9c682be8719ff1b2b64cbca290bd6faeb54423eac06443c6c088801750063036f7264010118746578742f706c61696e3b636861727365743d7574662d3800497b0a20202270223a20226272632d3230222c0a2020226f70223a20227472616e73666572222c0a2020227469636b223a20226f726469222c0a202022616d74223a2022313134220a7d6821c0117f692257b2331233b5705ce9c682be8719ff1b2b64cbca290bd6faeb54423e00000000', 'hex'));


        //tx: d5eb645a08ee99582fa8f21c16a536463a4fd1bdcc2cfe32f08a43d6293c1ed2 
        // ord have OP_PUSHDATA1
        //fs.writeFileSync('./tx1', Buffer.from('020000000001011f9cbcb6dee8a5557abc652b7cc744e349e27a77b53077d6c70b3e38b378130c0000000000fdffffff022202000000000000160014ab0f454683921b5cca8c15c9ae3c9c555cf8c47330090000000000001600149178f0bc39e3c4174da61e02d60ca4c8869b0d5403405cd72d2c8aa4ccd5a6f0d0de53faeb17640915e3febcdbba2fc146caa51b3fe52e5bb5d4b5a75fb793d5205a2e19585218d22f0b076dd155f214372af55cfb97a920117f692257b2331233b5705ce9c682be8719ff1b2b64cbca290bd6faeb54423eac06b8cc1e138801750063036f7264010118746578742f706c61696e3b636861727365743d7574662d38004c5a7b200a20202270223a20226f72632d3230222c0a2020227469636b223a20226f7263222c0a2020226964223a202232353034313630222c0a2020226f70223a20226d696e74222c0a202022616d74223a20223130303030220a7d6821c0117f692257b2331233b5705ce9c682be8719ff1b2b64cbca290bd6faeb54423e00000000', 'hex'));
        let res = fs.createReadStream('./tx1', { highWaterMark: 1024 });

        res.pipe(txstream)
    })
}

module.exports.testOrdParsing();